<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sheetlog Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div x-data="sheetlogDemo" class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Sheetlog Demo</h1>
    
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <p>Sheetlog is a library for logging and retrieving data from Google Sheets. It is designed to be easy to use and integrate into existing projects.</p>
      <p>Github repo: <a class="text-blue-500 hover:underline" href="https://github.com/janzheng/sheetlog">https://github.com/janzheng/sheetlog</a></p>
      <p>Live test sheet: <a class="text-blue-500 hover:underline" href="https://docs.google.com/spreadsheets/d/15XoANPN-DAyBkQlN9-s7bCaWzDNibuWTXHFCQMISVK4/edit?usp=sharing">Google Sheet</a></p>
      <hr class="my-4">
      <p>It can either be used in Node:</p>
      
      <pre class="bg-gray-100 p-4 rounded-md overflow-x-auto mb-4">
import { Sheetlog } from '@yawnxyz/sheetlog';

const sheet = new Sheetlog({
  sheetUrl: 'YOUR_SHEET_URL',
  sheet: 'Sheet1',
});

await sheet.log({ message: 'Hello world' }); // Basic logging
await sheet.get('123'); // Get by ID
await sheet.put('123', { message: 'Updated' }); // Update by ID 
await sheet.delete('123'); // Delete by ID
      </pre>



<p>Or as POST requests directly to the Apps Script:</p>
      <pre class="bg-gray-100 p-4 rounded-md overflow-x-auto mb-4">
// Simple POST request example
const response = await fetch('YOUR_SHEET_URL', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    method: 'POST',
    sheet: 'Sheet1',
    payload: {
      message: 'Hello from API',
      timestamp: new Date().toISOString()
    }
  })
});</pre>


      <h2 class="text-xl font-semibold mb-4">Setup</h2>
      <ol class="list-decimal ml-6 mb-6 space-y-2">
        <li>Create a new Google Sheet</li>
        <li>Go to Extensions > Apps Script</li>
        <li>Copy the Sheetlog library code into the script editor: <a class="text-blue-500 hover:underline" href="https://github.com/janzheng/sheetlog/blob/main/sheetlog.js">https://github.com/janzheng/sheetlog/blob/main/sheetlog.js</a></li>
        <li>Deploy as web app and copy the URL</li>
        <li>Paste the URL below to start using the demo</li>
      </ol>
      
      <input 
        type="text" 
        x-model="sheetUrl" 
        @input="updateSheetUrl"
        placeholder="Enter your Sheet Web App URL"
        class="w-full p-2 border rounded mb-4"
      >

      <p>As you try the examples below, the commands will be sent to the Apps Script in the above URL, and either read or write to the Google Sheets connected to the app.</p>
      <p>This demo uses the following Google Sheet: <a class="text-blue-500 hover:underline" href="https://docs.google.com/spreadsheets/d/15XoANPN-DAyBkQlN9-s7bCaWzDNibuWTXHFCQMISVK4/edit?usp=sharing">https://docs.google.com/spreadsheets/d/15XoANPN-DAyBkQlN9-s7bCaWzDNibuWTXHFCQMISVK4/edit?usp=sharing</a>
      </p>
    </div>


    <!-- Quick Start Demo Section -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-2xl font-bold mb-4">üé¨ Quick Start: Movie Database Demo</h2>
      <p class="mb-4">Let's start by loading some sample data into your sheet, then reading it back as a table!</p>
      
      <div class="space-y-4">
        <div>
          <button 
            @click="loadMovieData"
            :disabled="loadingMovies"
            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 disabled:bg-gray-400 font-semibold"
          >
            <span x-show="!loadingMovies">üì• Step 1: Load 200 Movies into Sheet</span>
            <span x-show="loadingMovies">‚è≥ Loading...</span>
          </button>
          <p class="text-sm text-gray-600 mt-2" x-show="movieLoadResult" x-text="movieLoadResult"></p>
        </div>

        <div>
          <button 
            @click="displayMoviesTable"
            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold"
          >
            üìä Step 2: Display Movies as Table
          </button>
        </div>

        <div x-show="moviesTable.length > 0" class="mt-4">
          <h3 class="font-semibold mb-2">Movies from Sheet:</h3>
          <div class="overflow-x-auto max-h-96 overflow-y-auto bg-white rounded-lg border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Director</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Genre</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="movie in moviesTable" :key="movie.title">
                  <tr>
                    <td class="px-4 py-2 text-sm" x-text="movie.title"></td>
                    <td class="px-4 py-2 text-sm" x-text="movie.year"></td>
                    <td class="px-4 py-2 text-sm" x-text="movie.director"></td>
                    <td class="px-4 py-2 text-sm" x-text="movie.genre"></td>
                    <td class="px-4 py-2 text-sm" x-text="movie.rating"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <p class="text-sm text-gray-600 mt-2">Showing <span x-text="moviesTable.length"></span> movies</p>
        </div>
      </div>
    </div>


    <div class="space-y-8">
      <template x-for="example in examples" :key="example.title">
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h3 x-text="example.title" class="text-xl font-semibold mb-2"></h3>
          <p x-text="example.description" class="text-gray-600 mb-4"></p>
          
          <div class="bg-gray-100 p-4 rounded-md mb-4">
            <textarea 
              x-model="example.payloadStr"
              @input="updatePayload($event, example)"
              class="w-full font-mono bg-transparent border-none focus:outline-none"
              rows="6"
            ></textarea>
          </div>
          
          <button 
            @click="executeExample(example)"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4"
          >
            Run Example
          </button>

          <div x-show="example.output" class="mt-4">
            <h4 class="font-semibold mb-2">Output:</h4>
            <pre class="bg-gray-100 p-4 rounded-md overflow-x-auto whitespace-pre-wrap"><code x-text="example.output"></code></pre>
          </div>
        </div>
      </template>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('sheetlogDemo', () => ({
        sheetUrl: '',
        loadingMovies: false,
        movieLoadResult: '',
        moviesTable: [],
        examples: [
          {
            title: 'Batch Upsert (Fast Sync)',
            description: 'Upsert multiple rows at once (efficient for syncing data)',
            payload: {
              method: "BATCH_UPSERT",
              sheet: "testSheet",
              idColumn: "email",
              payload: [
                 { email: "alice@example.com", name: "Alice", role: "Admin", status: "Active" },
                 { email: "bob@example.com", name: "Bob", role: "User", status: "Pending" }
              ]
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Batch Update',
            description: 'Update specific fields for multiple rows by internal _id',
            payload: {
              method: "BATCH_UPDATE",
              sheet: "testSheet",
              updates: [
                 { _id: 2, status: "Active" },
                 { _id: 3, status: "Inactive" }
              ]
            },
            payloadStr: '',
            output: ''
          },
          {
             title: 'List (Raw Mode)',
             description: 'Get list of rows as raw arrays (faster, less data overhead)',
             payload: {
                method: "GET",
                sheet: "testSheet",
                limit: 10,
                raw: true
             },
             payloadStr: '',
             output: ''
          },
          {
            title: 'Get All Cells (Fast Default)',
            description: 'Get all sheet data (values only) - optimized for speed',
            payload: {
              method: "GET_ALL_CELLS",
              sheet: "testSheet"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get All Cells (Full Details)',
            description: 'Get all sheet data including formulas and formatting (slower)',
            payload: {
              method: "GET_ALL_CELLS",
              sheet: "testSheet",
              includeFormulas: true,
              includeFormatting: true
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get Sheet Info',
            description: 'Get all sheet names and their IDs',
            payload: {
              method: "GET_SHEETS"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get Sheet as CSV',
            description: 'Get all data from a sheet tab as structured data',
            payload: {
              method: "GET_CSV",
              sheet: "testSheet"  // User can change this to their sheet name
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get Columns',
            description: 'Fetch column data from the sheet',
            payload: {
              method: "GET_COLUMNS",
              sheet: "testSheet",
              startColumn: "A",
              endColumn: "C"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get Rows',
            description: 'Fetch specific rows from the sheet',
            payload: {
              method: "GET_ROWS",
              sheet: "testSheet",
              startRow: 2,
              endRow: 5
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Create New Row',
            description: 'Add a new row of data',
            payload: {
              method: "POST",
              sheet: "testSheet",
              payload: {
                name: "John Doe",
                email: "john@example.com"
              }
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Update or Create Row (Upsert)',
            description: 'Create or update a row based on ID',
            payload: {
              method: "UPSERT",
              sheet: "testSheet",
              idColumn: "email",
              id: "john@example.com",
              partialUpdate: true,
              payload: {
                name: "John Doe Updated",
                status: "active"
              }
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Dynamic Post',
            description: 'Create row with automatic column creation (optimized)',
            payload: {
              method: "DYNAMIC_POST",
              sheet: "testSheet",
              payload: {
                newField: "newValue",
                anotherField: "anotherValue"
              }
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Find Records',
            description: 'Search for specific records',
            payload: {
              method: "FIND",
              sheet: "testSheet",
              idColumn: "Name",
              id: "Banana",
              returnAllMatches: true
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Paginated Get',
            description: 'Get paginated results',
            payload: {
              method: "PAGINATED_GET", 
              sheet: "testSheet",
              limit: 5,
              cursor: 2,
              sortBy: "Name",
              sortDir: "desc"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Range Update',
            description: 'Update multiple cells efficiently',
            payload: {
              method: "RANGE_UPDATE",
              sheet: "testSheet",
              startRow: 22,
              startCol: 5,
              data: [
                ["A1", "B1", "C1"],
                ["A2", "B2", "C2"]
              ]
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Aggregate',
            description: 'Perform calculations on columns',
            payload: {
              method: "AGGREGATE",
              sheet: "testSheet",
              column: "amount",
              operation: "sum"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Add Column',
            description: 'Add a new column to the sheet (optimized batch mode)',
            payload: {
              method: "ADD_COLUMN",
              sheet: "testSheet",
              columnName: "newColumn"
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Get Range',
            description: 'Get values from a specific range, optionally stopping at empty cells',
            payload: {
              method: "GET_RANGE",
              sheet: "testSheet",
              startRow: 2,
              startCol: 1,
              stopAtEmpty: false
            },
            payloadStr: '',
            output: ''
          },
          {
            title: 'Find Data Block',
            description: 'Automatically find and return a block of data within a search range',
            payload: {
              method: "GET_DATA_BLOCK",
              sheet: "testSheet",
              searchRange: {
                startRow: 1,
                startCol: 1,
                endRow: 99,
                endCol: 26  // Column Z
              }
            },
            payloadStr: '',
            output: ''
          }
        ],

        init() {
          this.examples.forEach(ex => {
            ex.payloadStr = JSON.stringify(ex.payload, null, 2);
          });
        },

        async loadMovieData() {
          if (!this.sheetUrl) {
            alert('Please enter a Sheet URL first');
            return;
          }

          this.loadingMovies = true;
          this.movieLoadResult = '';

          try {
            // Fetch movies from the JSON file
            const response = await fetch('/movies.json');
            const allMovies = await response.json();

            // Split into batches of 50 to avoid payload size issues
            const batchSize = 50;
            let totalInserted = 0;
            let totalUpdated = 0;

            for (let i = 0; i < allMovies.length; i += batchSize) {
              const batch = allMovies.slice(i, i + batchSize);
              this.movieLoadResult = `‚è≥ Loading batch ${Math.floor(i/batchSize) + 1} of ${Math.ceil(allMovies.length/batchSize)}...`;

              // Use BATCH_UPSERT with title as the ID column for efficient loading
              const result = await fetch('/api/sheet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  sheetUrl: this.sheetUrl,
                  payload: {
                    method: "BATCH_UPSERT",
                    sheet: "Demo",
                    idColumn: "title",
                    payload: batch
                  }
                })
              });

              const data = await result.json();
              
              if (data.status === 200) {
                totalInserted += data.data.inserted || 0;
                totalUpdated += data.data.updated || 0;
              } else {
                this.movieLoadResult = `‚ùå Error on batch ${Math.floor(i/batchSize) + 1}: ${JSON.stringify(data)}`;
                return;
              }

              // Small delay between batches
              await new Promise(resolve => setTimeout(resolve, 500));
            }

            this.movieLoadResult = `‚úÖ Success! Total Inserted: ${totalInserted}, Updated: ${totalUpdated}`;
          } catch (err) {
            this.movieLoadResult = `‚ùå Error: ${err.message}`;
          } finally {
            this.loadingMovies = false;
          }
        },

        async displayMoviesTable() {
          if (!this.sheetUrl) {
            alert('Please enter a Sheet URL first');
            return;
          }

          try {
            const response = await fetch('/api/sheet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sheetUrl: this.sheetUrl,
                payload: {
                  method: "GET",
                  sheet: "Demo",
                  limit: 1000
                }
              })
            });

            const result = await response.json();
            
            if (result.status === 200 && result.data) {
              this.moviesTable = result.data;
            } else {
              alert('Failed to load movies: ' + JSON.stringify(result));
            }
          } catch (err) {
            alert('Error loading movies: ' + err.message);
          }
        },

        updatePayload(event, example) {
          try {
            example.payload = JSON.parse(event.target.value);
            example.payloadStr = event.target.value;
          } catch (err) {
            example.payloadStr = event.target.value;
          }
        },

        async executeExample(example) {
          if (!this.sheetUrl) {
            alert('Please enter a Sheet URL first');
            return;
          }
          
          try {
            let payload;
            try {
              payload = JSON.parse(example.payloadStr);
            } catch (err) {
              throw new Error('Invalid JSON in payload');
            }

            const response = await fetch('/api/sheet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sheetUrl: this.sheetUrl,
                payload: payload
              })
            });
            const result = await response.json();
            example.output = JSON.stringify(result, null, 2);
          } catch (err) {
            example.output = 'Error: ' + err.message;
            console.error('Error:', err);
          }
        }
      }));
    });
  </script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    p {
      margin-bottom: 0.5rem;
    }
  </style>
</body>
</html>
